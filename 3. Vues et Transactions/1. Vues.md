# 01 - Les Vues (Views)

Une vue est une requête SQL sauvegardée que vous pouvez interroger comme une table.

## 1. Création d'une vue
```sql
CREATE VIEW v_olist_customers_sp AS
SELECT
    c.customer_id,
    c.customer_unique_id,
    c.customer_city,
    COUNT(o.order_id) AS nb_orders
FROM olist_customers_dataset c
LEFT JOIN olist_orders_dataset o ON o.customer_id = c.customer_id
WHERE c.customer_state = 'SP'
GROUP BY c.customer_id, c.customer_unique_id, c.customer_city;
```

## 2. Vues Matérialisées
Contrairement à une vue classique, elle stocke physiquement les données du résultat. Utile pour les calculs lourds qui ne changent pas souvent. 
!! Ne pas oublier de mettre à jour si nécessaire.

```sql
-- Syntaxe Postgres/DuckDB
CREATE MATERIALIZED VIEW mv_olist_monthly_sales AS
SELECT
    DATE_TRUNC('month', o.order_purchase_timestamp) AS month_start,
    SUM(oi.price + oi.freight_value) AS total_sales,
    COUNT(DISTINCT o.order_id) AS nb_orders
FROM olist_orders_dataset o
JOIN olist_order_items_dataset oi ON oi.order_id = o.order_id
GROUP BY 1;

-- Mise à jour
REFRESH MATERIALIZED VIEW mv_olist_monthly_sales;
```
